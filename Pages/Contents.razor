@page "/"
@page "/group/{groupId:guid}"
@inject IRecipeService RecipeService
@inject NavigationManager NavigationManager
@using Reci.Services.Interfaces

<PageTitle>@(selectedGroupName ?? "Contents")</PageTitle>

@if (isLoading)
{
    <FluentProgressRing />
    <p>Loading recipes...</p>
}
else if (filteredGroups is null || !filteredGroups.Any())
{
    <p>No recipes found. Start by adding your first recipe!</p>
}
else
{
    @foreach (var group in filteredGroups.OrderBy(g => g.SortOrder))
    {
        <div class="recipe-group">
            @if (!string.IsNullOrEmpty(group.Name) && GroupId == null)
            {
                <h2 class="group-heading">@group.Name</h2>
                @* <FluentLabel Class="group-heading">@group.Name</FluentLabel> *@
            }
            
            <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
                @foreach (var recipe in group)
                {
                    <FluentGridItem xs="12" sm="6" md="4" lg="3">
                        <FluentCard class="recipe-card" @onclick="() => NavigateToRecipe(recipe.Id)">
                            <h3>@recipe.Name</h3>
                            @if (!string.IsNullOrEmpty(recipe.Description))
                            {
                                <p class="recipe-description">@recipe.Description</p>
                            }
                            @if (recipe.Tags.Any())
                            {
                                <div class="recipe-tags">
                                    @foreach (var tag in recipe.Tags)
                                    {
                                        <FluentBadge Appearance="Appearance.Accent">@tag</FluentBadge>
                                    }
                                </div>
                            }
                        </FluentCard>
                    </FluentGridItem>
                }
            </FluentGrid>
        </div>
    }
}

@code {
    [Parameter]
    public Guid? GroupId { get; set; }

    private List<GroupVM<RecipeSummaryVM>>? recipeGroups;
    private List<GroupVM<RecipeSummaryVM>>? filteredGroups;
    private string? selectedGroupName;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecipes();
    }

    protected override void OnParametersSet()
    {
        FilterRecipes();
    }

    private async Task LoadRecipes()
    {
        try
        {
            recipeGroups = await RecipeService.GetRecipeSummariesAsync();
            FilterRecipes();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void FilterRecipes()
    {
        if (recipeGroups == null)
        {
            filteredGroups = null;
            return;
        }

        if (GroupId.HasValue)
        {
            filteredGroups = recipeGroups
                .Where(g => g.Id == GroupId.Value)
                .ToList();
            
            selectedGroupName = filteredGroups.FirstOrDefault()?.Name;
        }
        else
        {
            filteredGroups = recipeGroups;
            selectedGroupName = null;
        }
    }

    private void NavigateToRecipe(Guid recipeId)
    {
        NavigationManager.NavigateTo($"/recipe/{recipeId}");
    }
}