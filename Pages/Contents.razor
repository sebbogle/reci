@page "/"
@page "/group/{groupId:guid}"
@implements IDisposable
@inject IRecipeService RecipeService
@inject IRecipeStateNotifier RecipeStateNotifier
@inject NavigationManager NavigationManager

<PageTitle>@(selectedGroupName ?? "Contents")</PageTitle>

@if (isLoading)
{
    <FluentProgressRing />
    <p>Loading recipes...</p>
}
else if (GroupId.HasValue && (filteredGroups is null || !filteredGroups.Any()))
{
    <ItemNotFound ItemTypeLabel="group" />
}
else if (filteredGroups is null || !filteredGroups.Any())
{
    <FluentStack Orientation="Orientation.Vertical"
                 VerticalGap="15"
                 HorizontalAlignment="HorizontalAlignment.Center"
                 Style="margin-top: 50px;">
        <FluentLabel Color="Color.Custom" CustomColor="var(--neutral-foreground-hint)">
            No recipes found. Start by adding your first recipe!
        </FluentLabel>
    </FluentStack>
}
else
{            
    <FluentGrid Spacing="2" Justify="JustifyContent.FlexStart">
        @foreach (GroupVM<RecipeSummaryVM> group in filteredGroups.OrderBy(g => g.SortOrder))
        {
            @if (!string.IsNullOrEmpty(group.Name) && GroupId == null)
            {
                <FluentGridItem xs="12">
                    <FluentLabel Typo="Typography.H3">@group.Name</FluentLabel>
                </FluentGridItem>
            }

            @foreach (RecipeSummaryVM recipe in group)
            {
                <FluentGridItem xs="12" sm="6" md="4" lg="3" @key="recipe.Id">
                    <FluentCard class="recipe-card" MinimalStyle="true" @onclick="() => NavigateToRecipe(recipe.Id)">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentLabel Typo="Typography.H5">@recipe.Name</FluentLabel>

                            @if (!string.IsNullOrEmpty(recipe.Description))
                            {
                                <FluentLabel Id="@($"description-{recipe.Id}")" Color="Color.Custom" CustomColor="var(--neutral-foreground-hint)" Class="recipe-description">@recipe.Description</FluentLabel>
                                <FluentTooltip Anchor="@($"description-{recipe.Id}")" Position="TooltipPosition.Bottom" Delay="500" MaxWidth="300px">
                                    @recipe.Description
                                </FluentTooltip>
                            }
                            @if (recipe.Tags.Any())
                            {
                                <FluentStack HorizontalGap="3" Wrap="true">
                                    @foreach (string tag in recipe.Tags)
                                    {
                                        <FluentBadge Appearance="Appearance.Accent">@tag</FluentBadge>
                                    }
                                </FluentStack>
                            }
                        </FluentStack>
                    </FluentCard>
                </FluentGridItem>
            }
            <FluentGridItem xs="12" Style="margin-bottom: 10px;"></FluentGridItem>
        }
    </FluentGrid>
}

@code {
    [Parameter]
    public Guid? GroupId { get; set; }

    private List<GroupVM<RecipeSummaryVM>>? recipeGroups;
    private List<GroupVM<RecipeSummaryVM>>? filteredGroups;
    private string? selectedGroupName;
    private bool isLoading = true;
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();
        RecipeStateNotifier.OnRecipesChanged += OnRecipesChangedAsync;
        await LoadRecipes();
    }

    protected override void OnParametersSet()
    {
        FilterRecipes();
    }

    private async Task LoadRecipes()
    {
        if (_cts?.Token.IsCancellationRequested == true)
            return;

        try
        {
            recipeGroups = await RecipeService.GetRecipeSummariesAsync(_cts?.Token ?? default);
            FilterRecipes();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnRecipesChangedAsync()
    {
        if (_cts?.Token.IsCancellationRequested == true)
            return;

        await LoadRecipes();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        RecipeStateNotifier.OnRecipesChanged -= OnRecipesChangedAsync;
        _cts?.Cancel();
        _cts?.Dispose();
    }

    private void FilterRecipes()
    {
        if (recipeGroups == null)
        {
            filteredGroups = null;
            return;
        }

        if (GroupId.HasValue)
        {
            filteredGroups = recipeGroups
                .Where(g => g.Id == GroupId.Value)
                .ToList();
            
            selectedGroupName = filteredGroups.FirstOrDefault()?.Name;
        }
        else
        {
            filteredGroups = recipeGroups;
            selectedGroupName = null;
        }
    }

    private void NavigateToRecipe(Guid recipeId)
    {
        NavigationManager.NavigateTo($"/recipe/{recipeId}");
    }
}