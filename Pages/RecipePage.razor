@page "/Recipe/{RecipeSlug?}"
@implements IDisposable
@inject IRecipeService RecipeService
@inject IRecipeStateNotifier RecipeStateNotifier
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>@(Recipe?.Name ?? "Recipe")</PageTitle>

@if (isLoading)
{
    <FluentProgressRing />
    <p>Loading recipe...</p>
}
else if (Recipe is null)
{
    <ItemNotFound ItemTypeLabel="recipe" />
}
else
{
    <FluentGrid Spacing="1" Justify="JustifyContent.FlexStart">
        <FluentGridItem xs="12">
            <FluentStack Orientation="Orientation.Horizontal">
                <FluentLabel Typo="Typography.H1">@Recipe.Name</FluentLabel>
                <FluentSpacer />
                <FluentButton Appearance="Appearance.Accent"
                              IconEnd="@(new Icons.Regular.Size20.Edit())"
                              OnClick="OpenRecipeEditor"
                              Title="Edit recipe" />
            </FluentStack>
        </FluentGridItem>

        @if (Recipe.Group is not null)
        {
            <FluentGridItem xs="12">
                <FluentLabel Typo="Typography.H5" Color="Color.Custom" CustomColor="var(--neutral-foreground-hint)">@Recipe.Group.Name</FluentLabel>
            </FluentGridItem>
        }

        @if (Recipe.Tags.Any())
        {
            <FluentGridItem xs="12">
                <FluentStack HorizontalGap="3" Wrap="true">
                    @foreach (string tag in Recipe.Tags)
                    {
                        <FluentBadge Appearance="Appearance.Accent">@tag</FluentBadge>
                    }
                </FluentStack>
            </FluentGridItem>
        }

        @if (!string.IsNullOrWhiteSpace(Recipe.Description))
        {
            <FluentGridItem xs="12">
                <FluentLabel>@Recipe.Description</FluentLabel>
            </FluentGridItem>
        }
        
        <FluentGridItem xs="12">
            <FluentDivider Role="DividerRole.Separator" />
        </FluentGridItem>

        @if (Recipe.Ingredients.Any())
        {
            <FluentGridItem xs="12" md="6">
                <IngredientsDisplay Ingredients="@Recipe.Ingredients" />
            </FluentGridItem>            
        }

        @if (Recipe.Instructions.Any())
        {
            <FluentGridItem xs="12" md="6">
                <InstructionsDisplay Instructions="@Recipe.Instructions" />
            </FluentGridItem>  
        }

        @if (!Recipe.NutritionInfo.IsEmpty())
        {
            <FluentGridItem xs="12">
                <FluentDivider Role="DividerRole.Separator" />
            </FluentGridItem>
            <FluentGridItem xs="12">
                <NutritionInfoDisplay NutritionInfo="@Recipe.NutritionInfo" />
            </FluentGridItem>
        }

        @if (!string.IsNullOrEmpty(Recipe.FurtherNotes))
        {
            <FluentGridItem xs="12">
                <FluentDivider Role="DividerRole.Separator" />
            </FluentGridItem>
            <FluentGridItem xs="12">
                <RecipeNotesDisplay Notes="@Recipe.FurtherNotes" />
            </FluentGridItem>
        }

    </FluentGrid>
}

@code {
    [Parameter]
    public string? RecipeSlug { get; set; }

    private RecipeVM? Recipe { get; set; }
    private bool isLoading = true;
    private IDialogReference? _dialog;
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();
        RecipeStateNotifier.OnRecipesChanged += OnRecipesChangedAsync;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadRecipeAsync();
    }

    private async Task LoadRecipeAsync()
    {
        if (_cts?.Token.IsCancellationRequested == true)
            return;

        isLoading = true;
        
        bool success = Guid.TryParse(RecipeSlug, out Guid recipeId);
        Recipe = success ? await RecipeService.GetRecipeAsync(recipeId, _cts?.Token ?? default) : null;
        
        isLoading = false;
    }

    private async Task OnRecipesChangedAsync()
    {
        if (_cts?.Token.IsCancellationRequested == true)
            return;

        await LoadRecipeAsync();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        RecipeStateNotifier.OnRecipesChanged -= OnRecipesChangedAsync;
        try
        {
            _cts?.Cancel();
        }
        finally
        {
            _cts?.Dispose();
        }
    }

    private void NavigateToHome()
    {
        string currentPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (!string.IsNullOrEmpty(currentPath))
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task OpenRecipeEditor()
    {
        if (Recipe is null) return;

        _dialog = await DialogService.ShowPanelAsync<RecipeEditor>(Recipe, new DialogParameters()
        {
            Alignment = HorizontalAlignment.Left,
            Title = Recipe.Name,
            PrimaryAction = "Save",
            SecondaryAction = "Cancel",
            ShowDismiss = false,
            Width = "var(--panel-width, 950px)",
            PreventDismissOnOverlayClick = true,
        });

        DialogResult result = await _dialog.Result;
    }
}
