@page "/Recipe/{RecipeSlug?}"
@implements IDisposable
@inject IRecipeService RecipeService
@inject IRecipeStateNotifier RecipeStateNotifier
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>@(Recipe?.Name ?? "Recipe")</PageTitle>

@if (isLoading)
{
    <FluentProgressRing />
    <p>Loading recipe...</p>
}
else if (Recipe is null)
{
    <ItemNotFound ItemTypeLabel="recipe" />
}
else
{
    <div class="recipe-detail">
        <div class="recipe-header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                <h1 style="margin: 0;">@Recipe.Name</h1>
                <FluentButton Appearance="Appearance.Accent" 
                              IconEnd="@(new Icons.Regular.Size20.Edit())"
                              OnClick="OpenRecipeEditor"
                              Title="Edit recipe" />
            </div>
            
            @if (Recipe.Group is not null)
            {
                <div class="recipe-group-label">
                    @Recipe.Group.Name
                </div>
            }

            @if (Recipe.Tags.Any())
            {
                <div class="recipe-tags">
                    @foreach (var tag in Recipe.Tags)
                    {
                        <FluentBadge Appearance="Appearance.Accent">@tag</FluentBadge>
                    }
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(Recipe.Description))
            {
                <p class="recipe-description-detail">@Recipe.Description</p>
            }
        </div>

        <FluentGrid Spacing="3" Justify="JustifyContent.FlexStart">
            <FluentGridItem xs="12" md="6">
                <IngredientsDisplay Ingredients="@Recipe.Ingredients" />
            </FluentGridItem>

            <FluentGridItem xs="12" md="6">
                <InstructionsDisplay Instructions="@Recipe.Instructions" />
            </FluentGridItem>
        </FluentGrid>

        <NutritionInfoDisplay NutritionInfo="@Recipe.NutritionInfo" />

        <RecipeNotesDisplay Notes="@Recipe.FurtherNotes" />
    </div>
}

@code {
    [Parameter]
    public string? RecipeSlug { get; set; }

    private RecipeVM? Recipe { get; set; }
    private bool isLoading = true;
    private IDialogReference? _dialog;
    private CancellationTokenSource? _cts;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();
        RecipeStateNotifier.OnRecipesChanged += OnRecipesChangedAsync;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadRecipeAsync();
    }

    private async Task LoadRecipeAsync()
    {
        if (_cts?.Token.IsCancellationRequested == true)
            return;

        isLoading = true;
        
        bool success = Guid.TryParse(RecipeSlug, out Guid recipeId);
        Recipe = success ? await RecipeService.GetRecipeAsync(recipeId, _cts?.Token ?? default) : null;
        
        isLoading = false;
    }

    private async Task OnRecipesChangedAsync()
    {
        if (_cts?.Token.IsCancellationRequested == true)
            return;

        await LoadRecipeAsync();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        RecipeStateNotifier.OnRecipesChanged -= OnRecipesChangedAsync;
        _cts?.Cancel();
        _cts?.Dispose();
    }

    private void NavigateToHome()
    {
        string currentPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        if (!string.IsNullOrEmpty(currentPath))
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task OpenRecipeEditor()
    {
        if (Recipe is null) return;

        _dialog = await DialogService.ShowPanelAsync<RecipeEditor>(Recipe, new DialogParameters()
        {
            Alignment = HorizontalAlignment.Left,
            Title = Recipe.Name,
            PrimaryAction = "Save",
            SecondaryAction = "Cancel",
            ShowDismiss = false,
            Width = "var(--panel-width, 950px)",
            PreventDismissOnOverlayClick = true,
        });

        DialogResult result = await _dialog.Result;
    }
}
